<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logo上传功能诊断工具 - HKTCWAC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.544.0/dist/umd/lucide.min.js"></script>
    <script src="script.js"></script>
    <script src="fix-all.js"></script>
    <style>
        .debug-info {
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .status-good { background-color: #10B981; }
        .status-warning { background-color: #F59E0B; }
        .status-error { background-color: #EF4444; }
        .highlight-box {
            border: 2px solid #3B82F6;
            background-color: rgba(59, 130, 246, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8">Logo上传功能诊断工具</h1>
        
        <div class="max-w-6xl mx-auto space-y-6">
            <!-- 诊断概览 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i data-lucide="shield-check" class="w-6 h-6 mr-2 text-green-600"></i>
                    系统状态概览
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="border rounded-lg p-4">
                        <p class="font-medium">管理员登录状态</p>
                        <p><span id="login-status-indicator" class="status-indicator status-error"></span><span id="login-status-text">未登录</span></p>
                    </div>
                    <div class="border rounded-lg p-4">
                        <p class="font-medium">Logo上传按钮</p>
                        <p><span id="button-status-indicator" class="status-indicator status-error"></span><span id="button-status-text">不可用</span></p>
                    </div>
                    <div class="border rounded-lg p-4">
                        <p class="font-medium">自定义Logo</p>
                        <p><span id="logo-status-indicator" class="status-indicator status-warning"></span><span id="logo-status-text">未设置</span></p>
                    </div>
                </div>
            </div>
            
            <!-- Logo预览和测试 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i data-lucide="image" class="w-6 h-6 mr-2 text-blue-600"></i>
                    Logo预览和上传测试
                </h2>
                <div class="flex flex-col items-center space-y-6">
                    <!-- Logo预览区域 -->
                    <div class="text-center">
                        <h3 class="font-medium mb-2">当前Logo显示</h3>
                        <div class="relative inline-block" id="logo-preview-container">
                            <img id="test-logo-image" src="https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/97555580-13a0-4421-932a-4c653a157645~tplv-a9rns2rl98-image.image?rcl=2026020915252401000000000199530&rk3s=8e244e97&rrcfp=f06b921b&x-expires=1791294522&x-signature=kDnJ58aWp78vD%2FbV9%2F9H0dRxj6o%3D" alt="HKTCWAC Logo" class="h-24 w-24 object-contain border-2 border-gray-200 rounded-lg p-2">
                            <button id="test-logo-upload-btn" class="absolute -bottom-2 -right-2 bg-blue-600 text-white rounded-full w-8 h-8 text-sm flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity" onclick="document.getElementById('test-logo-upload').click()">
                                <i data-lucide="upload" class="w-4 h-4"></i>
                            </button>
                            <input type="file" id="test-logo-upload" accept="image/*" class="hidden" onchange="troubleshootHandleLogoUpload(event)">
                        </div>
                        <p class="text-sm text-gray-500 mt-2">鼠标悬停在Logo上查看上传按钮</p>
                    </div>
                    
                    <!-- 测试控制按钮 -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 w-full max-w-2xl">
                        <button onclick="troubleshootAdminLogin()" class="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center">
                            <i data-lucide="log-in" class="w-4 h-4 mr-2"></i>
                            模拟管理员登录
                        </button>
                        <button onclick="troubleshootAdminLogout()" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center">
                            <i data-lucide="log-out" class="w-4 h-4 mr-2"></i>
                            模拟管理员登出
                        </button>
                        <button onclick="clearCustomLogo()" class="bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors flex items-center justify-center">
                            <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                            清除自定义Logo
                        </button>
                        <button onclick="forceShowUploadButton()" class="bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center">
                            <i data-lucide="eye" class="w-4 h-4 mr-2"></i>
                            强制显示按钮
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 详细诊断信息 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i data-lucide="code-2" class="w-6 h-6 mr-2 text-purple-600"></i>
                    详细诊断信息
                </h2>
                <div class="space-y-4">
                    <div class="border rounded-lg p-4">
                        <h3 class="font-medium mb-2">JavaScript函数检查</h3>
                        <div class="space-y-2 debug-info">
                            <p><span id="func-check-admin" class="status-indicator status-error"></span> checkAdminLogin() 函数: <span id="func-admin-status">未找到</span></p>
                            <p><span id="func-check-logo" class="status-indicator status-error"></span> checkCustomLogo() 函数: <span id="func-logo-status">未找到</span></p>
                            <p><span id="func-handle-logo" class="status-indicator status-error"></span> handleLogoUpload() 函数: <span id="func-handle-status">未找到</span></p>
                        </div>
                    </div>
                    
                    <div class="border rounded-lg p-4">
                        <h3 class="font-medium mb-2">DOM元素检查</h3>
                        <div class="space-y-2 debug-info">
                            <p><span id="dom-check-logo" class="status-indicator status-error"></span> logo-image 元素: <span id="dom-logo-status">未找到</span></p>
                            <p><span id="dom-check-btn" class="status-indicator status-error"></span> logo-upload-btn 元素: <span id="dom-btn-status">未找到</span></p>
                            <p><span id="dom-check-input" class="status-indicator status-error"></span> logo-upload 元素: <span id="dom-input-status">未找到</span></p>
                        </div>
                    </div>
                    
                    <div class="border rounded-lg p-4">
                        <h3 class="font-medium mb-2">LocalStorage检查</h3>
                        <div class="space-y-2 debug-info">
                            <p><span id="storage-check-login" class="status-indicator status-error"></span> isLoggedIn: <span id="storage-login-value">未设置</span></p>
                            <p><span id="storage-check-user" class="status-indicator status-error"></span> adminUsername: <span id="storage-user-value">未设置</span></p>
                            <p><span id="storage-check-logo" class="status-indicator status-error"></span> customLogo: <span id="storage-logo-value">未设置</span></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 修复建议 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i data-lucide="wrench" class="w-6 h-6 mr-2 text-orange-600"></i>
                    修复建议
                </h2>
                <div id="fix-suggestions" class="space-y-3">
                    <div class="p-3 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-700">
                        <p class="font-medium">请先完成管理员登录，然后刷新页面重试</p>
                    </div>
                    <div class="p-3 bg-blue-50 border-l-4 border-blue-400 text-blue-700">
                        <p class="font-medium">确保您使用的是现代浏览器（Chrome、Firefox、Edge等）</p>
                    </div>
                    <div class="p-3 bg-blue-50 border-l-4 border-blue-400 text-blue-700">
                        <p class="font-medium">尝试清除浏览器缓存后重新访问网站</p>
                    </div>
                </div>
            </div>
            
            <!-- 操作日志 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i data-lucide="file-text" class="w-6 h-6 mr-2 text-gray-600"></i>
                    操作日志
                </h2>
                <div id="operation-log" class="bg-gray-50 rounded-lg p-4 h-40 overflow-y-auto debug-info text-sm">
                    <p>[INFO] 诊断工具已加载</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 添加日志条目
        function addLogEntry(message, type = 'INFO') {
            const logDiv = document.getElementById('operation-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('p');
            logEntry.innerHTML = `[${type}] ${timestamp}: ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // 更新状态指示器
        function updateStatusIndicator(elementId, status, text) {
            const indicator = document.getElementById(elementId + '-indicator');
            const textElement = document.getElementById(elementId + '-text');
            
            if (indicator) {
                indicator.className = `status-indicator status-${status}`;
            }
            if (textElement) {
                textElement.textContent = text;
            }
        }
        
        // 检查JavaScript函数
        function checkJavaScriptFunctions() {
            addLogEntry('开始检查JavaScript函数...');
            
            const functions = {
                'func-check-admin': 'checkAdminLogin',
                'func-check-logo': 'checkCustomLogo',
                'func-handle-logo': 'handleLogoUpload'
            };
            
            Object.entries(functions).forEach(([id, funcName]) => {
                const exists = typeof window[funcName] === 'function';
                const status = exists ? 'good' : 'error';
                const text = exists ? '已找到' : '未找到';
                
                updateStatusIndicator(id, status, text);
                addLogEntry(`${funcName}() 函数: ${text}`, exists ? 'INFO' : 'ERROR');
            });
        }
        
        // 检查DOM元素
        function checkDomElements() {
            addLogEntry('开始检查DOM元素...');
            
            const elements = {
                'dom-check-logo': 'logo-image',
                'dom-check-btn': 'logo-upload-btn',
                'dom-check-input': 'logo-upload'
            };
            
            Object.entries(elements).forEach(([id, elementId]) => {
                const element = document.getElementById(elementId);
                const exists = element !== null;
                const status = exists ? 'good' : 'error';
                const text = exists ? '已找到' : '未找到';
                
                updateStatusIndicator(id, status, text);
                addLogEntry(`${elementId} 元素: ${text}`, exists ? 'INFO' : 'ERROR');
            });
        }
        
        // 检查LocalStorage
        function checkLocalStorage() {
            addLogEntry('开始检查LocalStorage...');
            
            const items = {
                'storage-check-login': 'isLoggedIn',
                'storage-check-user': 'adminUsername',
                'storage-check-logo': 'customLogo'
            };
            
            Object.entries(items).forEach(([id, key]) => {
                const value = localStorage.getItem(key);
                const exists = value !== null;
                const status = exists ? 'good' : 'warning';
                const displayValue = exists ? (key === 'customLogo' ? '已设置 (Base64数据)' : value) : '未设置';
                
                updateStatusIndicator(id, status, displayValue);
                addLogEntry(`${key}: ${displayValue}`, exists ? 'INFO' : 'WARNING');
            });
        }
        
        // 更新系统状态概览
        function updateSystemStatus() {
            addLogEntry('更新系统状态概览...');
            
            const isLoggedIn = typeof checkAdminLogin === 'function' && checkAdminLogin();
            updateStatusIndicator('login-status', isLoggedIn ? 'good' : 'error', isLoggedIn ? '已登录' : '未登录');
            
            const buttonAvailable = isLoggedIn && document.getElementById('logo-upload-btn') !== null;
            updateStatusIndicator('button-status', buttonAvailable ? 'good' : 'error', buttonAvailable ? '可用' : '不可用');
            
            const hasCustomLogo = localStorage.getItem('customLogo') !== null;
            updateStatusIndicator('logo-status', hasCustomLogo ? 'good' : 'warning', hasCustomLogo ? '已设置' : '未设置');
        }
        
        // 生成修复建议
        function generateFixSuggestions() {
            addLogEntry('生成修复建议...');
            
            const suggestions = [];
            const isLoggedIn = typeof checkAdminLogin === 'function' && checkAdminLogin();
            const hasCustomLogo = localStorage.getItem('customLogo') !== null;
            
            if (!isLoggedIn) {
                suggestions.push({
                    type: 'warning',
                    title: '请先完成管理员登录',
                    message: '使用用户名 "admin" 和密码 "admin123" 登录系统'
                });
            }
            
            if (!hasCustomLogo) {
                suggestions.push({
                    type: 'info',
                    title: '尚未设置自定义Logo',
                    message: '登录后可以上传您的自定义Logo'
                });
            }
            
            // 显示建议
            const suggestionsDiv = document.getElementById('fix-suggestions');
            suggestionsDiv.innerHTML = '';
            
            suggestions.forEach(suggestion => {
                const div = document.createElement('div');
                const colors = {
                    warning: 'yellow',
                    info: 'blue',
                    error: 'red'
                };
                
                div.className = `p-3 bg-${colors[suggestion.type]}-50 border-l-4 border-${colors[suggestion.type]}-400 text-${colors[suggestion.type]}-700`;
                div.innerHTML = `
                    <p class="font-medium">${suggestion.title}</p>
                    <p>${suggestion.message}</p>
                `;
                
                suggestionsDiv.appendChild(div);
            });
        }
        
        // 诊断用的Logo上传处理
        function troubleshootHandleLogoUpload(event) {
            addLogEntry('测试Logo上传处理函数被调用');
            
            // 检查管理员权限
            if (typeof checkAdminLogin === 'function' && !checkAdminLogin()) {
                addLogEntry('未登录管理员账户，上传被拒绝', 'ERROR');
                if (typeof showNotification === 'function') {
                    showNotification('请先登录管理员账户', 'error');
                }
                return;
            }
            
            const file = event.target.files[0];
            if (!file) {
                addLogEntry('没有选择文件', 'WARNING');
                return;
            }
            
            addLogEntry(`选择的文件: ${file.name}, 类型: ${file.type}, 大小: ${(file.size / 1024).toFixed(2)} KB`);
            
            // 检查文件类型
            if (!file.type.startsWith('image/')) {
                addLogEntry('文件类型错误，不是图片文件', 'ERROR');
                if (typeof showNotification === 'function') {
                    showNotification('请选择图片文件', 'error');
                }
                return;
            }
            
            // 检查文件大小（限制为2MB）
            const maxSize = 2 * 1024 * 1024; // 2MB
            if (file.size > maxSize) {
                addLogEntry(`文件大小超过限制: ${(file.size / 1024).toFixed(2)} KB > 2048 KB`, 'ERROR');
                if (typeof showNotification === 'function') {
                    showNotification('图片大小不能超过2MB', 'error');
                }
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                addLogEntry('文件读取完成，更新Logo');
                
                // 更新测试Logo图片
                const logoImage = document.getElementById('test-logo-image');
                if (logoImage) {
                    logoImage.src = e.target.result;
                    addLogEntry('测试Logo图片已更新');
                }
                
                // 保存到localStorage（Base64格式）
                try {
                    localStorage.setItem('customLogo', e.target.result);
                    addLogEntry('Logo已保存到localStorage');
                    if (typeof showNotification === 'function') {
                        showNotification('Logo上传成功！', 'success');
                    }
                    
                    // 更新状态
                    updateSystemStatus();
                    checkLocalStorage();
                    generateFixSuggestions();
                } catch (error) {
                    addLogEntry(`保存Logo失败: ${error.message}`, 'ERROR');
                    if (typeof showNotification === 'function') {
                        showNotification('Logo保存失败，请重试', 'error');
                    }
                }
            };
            
            reader.onerror = function() {
                addLogEntry('文件读取失败', 'ERROR');
                if (typeof showNotification === 'function') {
                    showNotification('图片读取失败，请重试', 'error');
                }
            };
            
            addLogEntry('开始读取文件...');
            reader.readAsDataURL(file);
        }
        
        // 模拟管理员登录
        function troubleshootAdminLogin() {
            addLogEntry('执行模拟管理员登录', 'ACTION');
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('adminUsername', 'admin');
            
            // 更新状态
            updateSystemStatus();
            checkLocalStorage();
            generateFixSuggestions();
            
            if (typeof showNotification === 'function') {
                showNotification('已模拟管理员登录', 'success');
            }
        }
        
        // 模拟管理员登出
        function troubleshootAdminLogout() {
            addLogEntry('执行模拟管理员登出', 'ACTION');
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('adminUsername');
            
            // 更新状态
            updateSystemStatus();
            checkLocalStorage();
            generateFixSuggestions();
            
            if (typeof showNotification === 'function') {
                showNotification('已模拟管理员登出', 'success');
            }
        }
        
        // 清除自定义Logo
        function clearCustomLogo() {
            addLogEntry('执行清除自定义Logo', 'ACTION');
            localStorage.removeItem('customLogo');
            
            // 更新Logo显示
            const logoImage = document.getElementById('test-logo-image');
            if (logoImage) {
                logoImage.src = "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/97555580-13a0-4421-932a-4c653a157645~tplv-a9rns2rl98-image.image?rcl=2026020915252401000000000199530&rk3s=8e244e97&rrcfp=f06b921b&x-expires=1791294522&x-signature=kDnJ58aWp78vD%2FbV9%2F9H0dRxj6o%3D";
            }
            
            // 更新状态
            updateSystemStatus();
            checkLocalStorage();
            generateFixSuggestions();
            
            if (typeof showNotification === 'function') {
                showNotification('已清除自定义Logo', 'success');
            }
        }
        
        // 强制显示上传按钮
        function forceShowUploadButton() {
            addLogEntry('执行强制显示上传按钮', 'ACTION');
            
            const uploadBtn = document.getElementById('test-logo-upload-btn');
            if (uploadBtn) {
                uploadBtn.style.opacity = '1';
                uploadBtn.style.pointerEvents = 'auto';
                addLogEntry('上传按钮已强制显示');
            } else {
                addLogEntry('未找到上传按钮元素', 'ERROR');
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            addLogEntry('诊断工具页面加载完成');
            
            // 等待一段时间确保其他脚本加载完成
            setTimeout(() => {
                // 执行所有检查
                checkJavaScriptFunctions();
                checkDomElements();
                checkLocalStorage();
                updateSystemStatus();
                generateFixSuggestions();
                
                // 设置测试Logo
                const customLogo = localStorage.getItem('customLogo');
                const logoImage = document.getElementById('test-logo-image');
                if (customLogo && logoImage) {
                    logoImage.src = customLogo;
                    addLogEntry('已加载自定义Logo');
                }
                
                // 设置上传按钮事件
                const uploadBtn = document.getElementById('test-logo-upload-btn');
                if (uploadBtn) {
                    uploadBtn.addEventListener('mouseenter', function() {
                        if (typeof checkAdminLogin === 'function' && checkAdminLogin()) {
                            this.style.opacity = '1';
                        }
                    });
                    
                    uploadBtn.addEventListener('mouseleave', function() {
                        this.style.opacity = '0';
                    });
                }
                
                addLogEntry('诊断初始化完成');
            }, 1000);
        });
    </script>
</body>
</html>